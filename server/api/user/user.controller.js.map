{"version":3,"sources":["api/user/user.controller.js"],"names":[],"mappings":"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","file":"api/user/user.controller.js","sourcesContent":["'use strict';\n\nimport User from './user.model';\nimport passport from 'passport';\nimport config from '../../config/environment/index';\nimport jwt from 'jsonwebtoken';\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    res.status(statusCode).json(err);\n  }\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nfunction respondWith(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function() {\n    res.status(statusCode).end();\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexports.index = function(req, res) {\n  User.findAsync({}, '-salt -hashedPassword')\n    .then(function(users) {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n};\n\n/**\n * Creates a new user\n */\nexports.create = function(req, res, next) {\n  var newUser = new User(req.body);\n  newUser.provider = 'local';\n  newUser.role = 'user';\n  newUser.saveAsync()\n    .spread(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresInMinutes: 60 * 5\n      });\n      res.json({ token: token });\n    })\n    .catch(validationError(res));\n};\n\n/**\n * Get a single user\n */\nexports.show = function(req, res, next) {\n  var userId = req.params.id;\n\n  User.findByIdAsync(userId)\n    .then(function(user) {\n      if (!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(function(err) {\n      return next(err);\n    });\n};\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexports.destroy = function(req, res) {\n  User.findByIdAndRemoveAsync(req.params.id)\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n};\n\n/**\n * Change a users password\n */\nexports.changePassword = function(req, res, next) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  User.findByIdAsync(userId)\n    .then(function(user) {\n      if (user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.saveAsync()\n          .then(function() {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n};\n\n/**\n * Get my info\n */\nexports.me = function(req, res, next) {\n  var userId = req.user._id;\n  var role = req.user.role;\n  if (role === 'guest') {\n    //todo refactor it\n    let user = {\n      name:'guest',\n      avatar: 'assets/images/anonymous.png',\n      role:'guest'\n    };\n    res.json(user);\n  } else {\n    User.findOneAsync({_id: userId}, '-salt -hashedPassword')\n        .then(function (user) { // don't ever give out the password or salt\n          if (!user) {\n            return res.status(401).end();\n          }\n          res.json(user);\n        })\n        .catch(function (err) {\n          return next(err);\n        });\n  }\n};\n\n/**\n * Authentication callback\n */\nexports.authCallback = function(req, res, next) {\n  res.redirect('/');\n};\n"],"sourceRoot":"/source/"}